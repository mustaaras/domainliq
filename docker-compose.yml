services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - AUTH_SECRET=${AUTH_SECRET}
      - AUTH_TRUST_HOST=true
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/api/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    extra_hosts:
      - "host.docker.internal:host-gateway"
    labels:
      - "traefik.docker.network=coolify"
      # ---------------------------------------------------------
      # 1. WILDCARD ROUTERS (*.domainliq.com) - HIGH PRIORITY
      # ---------------------------------------------------------
      # HTTP Router (Redirects to HTTPS)
      - "traefik.http.routers.domainliq-wildcard-http.rule=Host(`test.domainliq.com`) || Host(`aras.domainliq.com`) || HostRegexp(`^.+\\.domainliq\\.com$`)"
      - "traefik.http.routers.domainliq-wildcard-http.entrypoints=http"
      - "traefik.http.routers.domainliq-wildcard-http.middlewares=redirect-to-https"
      - "traefik.http.routers.domainliq-wildcard-http.priority=100"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

      # HTTPS Router
      - "traefik.http.routers.domainliq-wildcard.rule=Host(`test.domainliq.com`) || Host(`aras.domainliq.com`) || HostRegexp(`^.+\\.domainliq\\.com$`)"
      - "traefik.http.routers.domainliq-wildcard.entrypoints=https"
      - "traefik.http.routers.domainliq-wildcard.tls=true"
      - "traefik.http.routers.domainliq-wildcard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.domainliq-wildcard.priority=100"

      # FORCE Wildcard Certificate (Only for these domains)
      - "traefik.http.routers.domainliq-wildcard.tls.domains[0].main=domainliq.com"
      - "traefik.http.routers.domainliq-wildcard.tls.domains[0].sans=*.domainliq.com"

      # ---------------------------------------------------------
      # 2. CATCH-ALL ROUTERS (REMOVED) - Coolify API handles specific domains
      # ---------------------------------------------------------
      # Logic moved to explicit routers generated by Coolify when domains are added via API.


      # ---------------------------------------------------------
      # SERVICE DEFINITION
      # ---------------------------------------------------------
      - "traefik.http.routers.domainliq-wildcard.service=domainliq-service"
      - "traefik.http.services.domainliq-service.loadbalancer.server.port=3000"
    networks:
      - coolify

networks:
  coolify:
    external: true
