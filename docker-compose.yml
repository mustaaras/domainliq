services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - AUTH_SECRET=${AUTH_SECRET}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/api/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    extra_hosts:
      - "host.docker.internal:host-gateway"
    labels:
      - "traefik.docker.network=coolify"
      # ---------------------------------------------------------
      # 1. WILDCARD ROUTERS (*.domainliq.com) - HIGH PRIORITY
      # ---------------------------------------------------------
      # HTTP Router (Redirects to HTTPS)
      - "traefik.http.routers.domainliq-wildcard-http.rule=Host(`test.domainliq.com`) || Host(`aras.domainliq.com`) || HostRegexp(`^.+\\.domainliq\\.com$`)"
      - "traefik.http.routers.domainliq-wildcard-http.entrypoints=http"
      - "traefik.http.routers.domainliq-wildcard-http.middlewares=redirect-to-https"
      - "traefik.http.routers.domainliq-wildcard-http.priority=100"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

      # HTTPS Router
      - "traefik.http.routers.domainliq-wildcard.rule=Host(`test.domainliq.com`) || Host(`aras.domainliq.com`) || HostRegexp(`^.+\\.domainliq\\.com$`)"
      - "traefik.http.routers.domainliq-wildcard.entrypoints=https"
      - "traefik.http.routers.domainliq-wildcard.tls=true"
      - "traefik.http.routers.domainliq-wildcard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.domainliq-wildcard.priority=100"

      # FORCE Wildcard Certificate (Only for these domains)
      - "traefik.http.routers.domainliq-wildcard.tls.domains[0].main=domainliq.com"
      - "traefik.http.routers.domainliq-wildcard.tls.domains[0].sans=*.domainliq.com"

      # ---------------------------------------------------------
      # 2. CATCH-ALL ROUTERS (Custom Domains) - LOW PRIORITY
      # ---------------------------------------------------------
      # HTTP Router (Redirects to HTTPS)
      - "traefik.http.routers.domainliq-catchall-http.rule=HostRegexp(`{host:.+}`)"
      - "traefik.http.routers.domainliq-catchall-http.entrypoints=http"
      - "traefik.http.routers.domainliq-catchall-http.middlewares=redirect-to-https"
      - "traefik.http.routers.domainliq-catchall-http.priority=1"

      # HTTPS Router
      - "traefik.http.routers.domainliq-catchall.rule=HostRegexp(`{host:.+}`)"
      - "traefik.http.routers.domainliq-catchall.entrypoints=https"
      - "traefik.http.routers.domainliq-catchall.tls=true"
      # Use HTTP Challenge resolver for custom domains (On-Demand)
      - "traefik.http.routers.domainliq-catchall.tls.certresolver=letsencrypt_http"
      - "traefik.http.routers.domainliq-catchall.priority=1"
      # Connect both routers to the same service
      # - "traefik.http.routers.domainliq-catchall.service=app"

      # ---------------------------------------------------------
      # SERVICE DEFINITION
      # ---------------------------------------------------------
      # - "traefik.http.routers.domainliq-wildcard.service=app"
      - "traefik.http.services.app.loadbalancer.server.port=3000"
    networks:
      - coolify

networks:
  coolify:
    external: true
