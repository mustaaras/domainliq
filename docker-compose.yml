services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - AUTH_SECRET=${AUTH_SECRET}
      - AUTH_TRUST_HOST=true
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/api/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - coolify

  caddy:
    build:
      context: .
      dockerfile: Dockerfile.caddy
    restart: always
    volumes:
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - app
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=coolify"
      # TCP Router for Custom Domains (Passthrough to Caddy)
      # Priority 1: Lowest, so *.domainliq.com (Priority 100) takes precedence.
      - "traefik.tcp.routers.caddy-catchall.rule=HostSNI(`*`)"
      - "traefik.tcp.routers.caddy-catchall.entrypoints=https"
      - "traefik.tcp.routers.caddy-catchall.service=caddy-service"
      - "traefik.tcp.routers.caddy-catchall.priority=1"
      # Caddy Service
      - "traefik.tcp.services.caddy-service.loadbalancer.server.port=8443"
    networks:
      - coolify

volumes:
  caddy_data:
  caddy_config:


networks:
  coolify:
    external: true
